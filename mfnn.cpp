#include <iostream>
#include <vector>
#include <unordered_map>
#include <cmath>
#include <random>
#include <fstream>
#include <sstream>  
#include<thread>
#include<mutex>
#include<stdlib.h>
#include<functional>

std::mutex loss_mutex;

std::vector<float> softmax(const std::vector<float>& logits) {
    std::vector<float> probs(logits.size());
    float sum = 0.0f;
    for (float logit : logits) {
        sum += std::exp(logit);
    }
    for (size_t i = 0; i < logits.size(); ++i) {
        probs[i] = std::exp(logits[i]) / sum;
    }
    return probs;
}
int sampleFromDistribution(const std::vector<float>& probs) {
    std::random_device rd;
    std::mt19937 gen(rd());
    std::discrete_distribution<> dist(probs.begin(), probs.end());
    return dist(gen);
}
std::unordered_map<std::string, int> createStringVocabulary(const std::string& dataset) {
    std::unordered_map<std::string, int> vocab;
    int idx = 0;
    for (size_t c = 0; c <= dataset.size() - 4; ++c) {
        std::string token = dataset.substr(c, 4);
        if (vocab.find(token) == vocab.end()) {
            vocab[token] = idx++;
        }
    }
    return vocab;
}
class RNN {
private:
    float saved_loss = 60000.0f;
    int input_size, hidden_size, output_size;
    std::vector<std::vector<float>> Wxh, Whh, Why;
    std::vector<float> bh, by;
    std::vector<float> h_prev;
    float learning_rate;

    float tanh(float x) {
        return std::tanh(x);
    }

    float tanh_derivative(float x) {
        return 1.0f - x * x;
    }

public:
    RNN(int input_size, int hidden_size, int output_size, float lr = 0.002)
        : input_size(input_size), hidden_size(hidden_size), output_size(output_size), learning_rate(lr) {
        std::random_device rd;
        std::mt19937 gen(rd());
        std::uniform_real_distribution<float> dist(-0.1f, 0.1f);

        Wxh.resize(input_size, std::vector<float>(hidden_size));
        Whh.resize(hidden_size, std::vector<float>(hidden_size));
        Why.resize(hidden_size, std::vector<float>(output_size));
        bh.resize(hidden_size, 0.0f);
        by.resize(output_size, 0.0f);
        h_prev.resize(hidden_size, 0.0f);

        for (auto& row : Wxh) for (auto& w : row) w = dist(gen);
        for (auto& row : Whh) for (auto& w : row) w = dist(gen);
        for (auto& row : Why) for (auto& w : row) w = dist(gen);
    }
    std::vector<float> forward(const std::vector<float>& x) {
        std::vector<float> h(hidden_size, 0.0f);

        for (int i = 0; i < hidden_size; ++i) {
            for (int j = 0; j < input_size; ++j) {
                h[i] += x[j] * Wxh[j][i];
            }
            for (int j = 0; j < hidden_size; ++j) {
                h[i] += h_prev[j] * Whh[j][i];
            }
            h[i] += bh[i];
            h[i] = tanh(h[i]);
        }

        h_prev = h;

        std::vector<float> y(output_size, 0.0f);
        for (int i = 0; i < output_size; ++i) {
            for (int j = 0; j < hidden_size; ++j) {
                y[i] += h[j] * Why[j][i];
            }
            y[i] += by[i];
        }

        return softmax(y);
    }
    void saveWeights(const std::string& filename) {
        std::ofstream file("example.txt", std::ios::binary | std::ios::trunc);
        if (!file) {
            throw std::runtime_error("Failed to open file for saving weights.");
        }

        for (const auto& row : Wxh)
            file.write(reinterpret_cast<const char*>(row.data()), row.size() * sizeof(float));
        for (const auto& row : Whh)
            file.write(reinterpret_cast<const char*>(row.data()), row.size() * sizeof(float));
        for (const auto& row : Why)
            file.write(reinterpret_cast<const char*>(row.data()), row.size() * sizeof(float));
        file.write(reinterpret_cast<const char*>(bh.data()), bh.size() * sizeof(float));
        file.write(reinterpret_cast<const char*>(by.data()), by.size() * sizeof(float));

        file.close();
    }
    float computeLoss(const std::vector<float>& y, const std::vector<float>& target) {
        float loss = 0.0f;
        for (size_t i = 0; i < y.size(); ++i) {
            loss -= target[i] * std::log(y[i] + 1e-9);
        }
        return loss;
    }
    void train(const std::vector<float>& x, const std::vector<float>& target) {
        auto y = forward(x);

        std::vector<float> dy(output_size, 0.0f);
        for (size_t i = 0; i < output_size; ++i) {
            dy[i] = y[i] - target[i];
        }

        std::vector<std::vector<float>> dWhy(hidden_size, std::vector<float>(output_size, 0.0f));
        std::vector<float> dby(output_size, 0.0f);
        for (int i = 0; i < output_size; ++i) {
            for (int j = 0; j < hidden_size; ++j) {
                dWhy[j][i] = dy[i] * h_prev[j];
            }
            dby[i] = dy[i];
        }
        for (int i = 0; i < hidden_size; ++i) {
            for (int j = 0; j < output_size; ++j) {
                Why[i][j] -= learning_rate * dWhy[i][j];
            }
        }
        for (int i = 0; i < output_size; ++i) {
            by[i] -= learning_rate * dby[i];
        }
    }
};

void trainBatch(RNN& rnn, const std::string& dataset, const std::unordered_map<std::string, int>& vocab,
    size_t start_idx, size_t end_idx, float& total_loss) {
    std::vector<float> input(vocab.size(), 0.0f);
    std::vector<float> target(vocab.size(), 0.0f);

    for (size_t i = start_idx; i < end_idx; i += 4) {
        input.assign(vocab.size(), 0.0f);
        target.assign(vocab.size(), 0.0f);

        std::string input_seq = dataset.substr(i, 4);
        std::string target_seq = dataset.substr(i + 4, 4);

        input[vocab.at(input_seq)] = 1.0f;
        target[vocab.at(target_seq)] = 1.0f;

        rnn.train(input, target);
        auto y = rnn.forward(input);
        float loss = rnn.computeLoss(y, target);

        std::lock_guard<std::mutex> lock(loss_mutex);
        total_loss += loss;
    }
}



std::string generateText(RNN& rnn, const std::unordered_map<std::string, int>& vocab, const std::string& start_token, int length) {
    std::unordered_map<int, std::string> reverse_vocab;
    for (const auto& [token, idx] : vocab) {
        reverse_vocab[idx] = token;
    }

    if (vocab.find(start_token) == vocab.end()) {
        throw std::invalid_argument("Start token not found in vocabulary!");
    }

    std::string generated = start_token;
    std::vector<float> input(vocab.size(), 0.0f);

    std::string current_token = start_token;
    for (int i = 0; i < length; ++i) {
        if (vocab.find(current_token) == vocab.end()) {
            std::cerr << "Token '" << current_token << "' not found in vocabulary. Stopping generation." << std::endl;
            break;
        }

        input.assign(vocab.size(), 0.0f);
        input[vocab.at(current_token)] = 1.0f;

        auto output = rnn.forward(input);
        int next_idx = sampleFromDistribution(output);

        if (reverse_vocab.find(next_idx) == reverse_vocab.end()) {
            std::cerr << "Generated index " << next_idx << " not found in reverse vocabulary. Stopping generation." << std::endl;
            break;
        }

        current_token = reverse_vocab[next_idx];
        generated += current_token;
    }

    return generated;
}

std::string loadDataset() {
    std::string dataset = "Жил человек в лесу возле Синих гор. Он много работал, а работы не убавлялось, и ему нельзя было уехать домой в отпуск. Наконец, когда наступила зима, он совсем заскучал, попросил разрешения у начальников и послал своей жене письмо, чтобы она приезжала вместе с ребятишками к нему в гости. Ребятишек у него было двое — Чук и Гек. А жили они с матерью в далеком огромном городе, лучше которого и нет на свете. Днем и ночью сверкали над башнями этого города красные звезды. И, конечно, этот город назывался Москва. Как раз в то время, когда почтальон с письмом поднимался по лестнице, у Чука с Геком был бой. Короче говоря, они просто выли и дрались. Из-за чего началась эта драка, я уже позабыл. Но помнится мне, что или Чук стащил у Гека пустую спичечную коробку, или, наоборот, Гек стянул у Чука жестянку из-под ваксы. Только что оба эти брата, стукнув по разу друг друга кулаками, собирались стукнуть по второму, как загремел звонок, и они с тревогой переглянулись. Они подумали, что пришла их мама! А у этой мамы был странный характер. Она не ругалась за драку, не кричала, а просто разводила драчунов по разным комнатам и целый час, а то и два не позволяла им играть вместе. А в одном часе — тик да так — целых шестьдесят минут. А в двух часах и того больше. Вот почему оба брата мигом вытерли слезы и бросились открывать дверь. Но, оказывается, это была не мать, а почтальон, который принес письмо. Тогда они закричали: — Это письмо от папы! Да, да, от папы! И он, наверное, скоро приедет. Тут, на радостях, они стали скакать, прыгать и кувыркаться по пружинному дивану. Потому что хотя Москва и самый замечательный город, но когда папа вот уже целый год как не был дома, то и в Москве может стать скучно. И так они развеселились, что не заметили, как вошла их мать. Она очень удивилась, увидав, что оба ее прекрасных сына, лежа на спинах, орут и колотят каблуками по стене, да так здорово, что трясутся картины над диваном и гудит пружина стенных часов. Но когда мать узнала, отчего такая радость, то сыновей не заругала. Она только турнула их с дивана. Кое-как сбросила она шубку и схватила письмо, даже не стряхнув с волос снежинок, которые теперь растаяли и сверкали, как искры, над ее темными бровями. Всем известно, что письма бывают веселые или печальные, и поэтому, пока мать читала, Чук и Гек внимательно следили за ее лицом. Сначала мать нахмурилась, и они нахмурились тоже. Но потом она заулыбалась, и они решили, что это письмо веселое. — Отец не приедет, — откладывая письмо, сказала мать. — У него еще много работы, и его в Москву не отпускают. Обманутые Чук и Гек растерянно глянули друг на друга. Письмо казалось самым что ни на есть распечальным. Они разом надулись, засопели и сердито посмотрели на мать, которая неизвестно чему улыбалась. — Он не приедет, —продолжала мать, —но он зовет нас всех к себе в гости. Чук и Гек спрыгнули с дивана. — Он чудак человек, — вздохнула мать. — Хорошо сказать — в гости! Будто бы это сел на трамвай и поехал... — Да, да, — быстро подхватил Чук, — раз он зовет, так мы сядем и поедем. — Ты глупый, — сказала мать. — Туда ехать тысячу и еще тысячу километров поездом. А потом в санях лошадьми через тайгу. А в тайге наткнешься на волка или на медведя. И что это за странная затея! Вы только подумайте сами! — Гей-гей! — Чук и Гек не думали и полсекунды, а в один голос заявили, что они решили ехать не только тысячу а даже сто тысяч километров. Им ничего не страшно. Они храбрые. И это они вчера прогнали камнями засучившую во двор чужую собаку. И так они говорили долго, размахивали руками, притопывали, подпрыгивали, а мать сидела молча, все их слушала, слушала. Наконец рассмеялась, схватила обоих на руки, завертела и свалила на диван. Знайте, она давно уже ждала такого письма, и это она только нарочно поддразнивала Чука и Гека, потому что веселый у нее был характер. Прошла целая неделя, прежде чем мать собрала их в дорогу. Чук и Гек времени даром не теряли тоже. Чук смастерил себе кинжал из кухонного ножика, а Гек разыскал себе гладкую палку, забил в нее гвоздь, и получилась пика, до того крепкая, что если бы чем-нибудь проколоть шкуру медведя, а потом ткнуть этой пикой в сердце, то, конечно, медведь сдох бы сразу. Наконец все дела были закончены. Уже запаковали багаж.";
    dataset += " Приделали второй замок к двери, чтобы не обокрали квартиру воры. Вытряхнули из шкафа остатки хлеба, муки и крупы, чтобы не развелись мыши. И вот мать уехала на вокзал покупать билеты на вечерний завтрашний поезд. Но тут без нее у Чука с Геком получилась ссора. Ах, если бы только знали они, до какой беды доведет их эта ссора, то ни за что бы в этот день они не поссорились! У запасливого Чука была плоская металлическая коробочка, в которой он хранил серебряные бумажки от чая, конфетные обертки (если там был нарисован танк, самолет или красноармеец), галчиные перья для стрел, конский волос для китайского фокуса и еще всякие очень нужные вещи. У Гека такой коробочки не было. Да и вообще Гек был разиня, но зато он умел петь песни. И вот как раз в то время, когда Чук шел доставать из укромного места свою драгоценную коробочку, а Гек в комнате пел песни, вошел почтальон и передал Чуку телеграмму для матери. Чук спрятал телеграмму в свою коробочку и пошел узнать, почему это Гек уже не поет песни, а кричит: Р-ра! Р-ра! Ура! Эй! Бей! Турумбей! Чук с любопытством приоткрыл дверь и увидел такой «турумбей», что от злости у него затряслись руки. Посреди комнаты стоял стул, и на спинке его висела вся истыканная пикой, разлохмаченная газета. И это ничего. Но проклятый Гек, вообразив, что перед ним туша медведя, яростно тыкал пикой в желтую картонку из-под маминых ботинок. А в картонке у Чука хранилась сигнальная жестяная дудка, три цветных значка от Октябрьских праздников и деньги — сорок шесть копеек, которые он не истратил, как Гек, на разные глупости, а запасливо приберег в дальнюю дорогу. И, увидав продырявленную картонку, Чук вырвал у Гека пику, переломил ее о колено и швырнул на пол. Но, как ястреб, налетел Гек на Чука и выхватил у него из рук металлическую коробку. Одним махом взлетел на подоконник и выкинул коробку через открытую форточку. Громко завопил оскорбленный Чук и с криком: «Телеграмма! Телеграмма!» — в одном пальто, без калош и шапки, выскочил за дверь. Почуяв неладное, вслед за Чуком понесся Гек. Но напрасно искали они металлическую коробочку, в которой лежала еще никем не прочитанная телеграмма. То ли она попала в сугроб и теперь лежала глубоко под снегом, то ли она упала на тропку и ее утянул какой-либо прохожий, но, так или иначе, вместе со всем добром и нераспечатанной телеграммой коробка навеки пропала. Вернувшись домой, Чук и Гек долго молчали. Они уже помирились, так как знали, что попадет им от матери обоим. Но так как Чук был на целый год старше Гека, то, опасаясь, как бы ему не попало больше, он придумал: -— Знаешь, Гек: а что, если мы маме про телеграмму ничего не скажем? Подумаешь — телеграмма! Нам и без телеграммы весело. — Врать нельзя, — вздохнул Гек. — Мама за вранье всегда еще хуже сердится. — А мы не будем врать! — радостно воскликнул Чук. — Если она спросит, где телеграмма, — мы скажем. Если же не спросит, то зачем нам вперед выскакивать? Мы не выскочки. — Ладно, — согласился Гек. — Если врать не надо, то так и сделаем. Это ты хорошо, Чук, придумал. И только что они на этом порешили, как вошла мать. Она была довольна, потому что достала хорошие билеты на поезд, но все же она сразу заметила, что у ее дорогих сыновей лица печальны, а глаза заплаканы. — Отвечайте, граждане, — отряхиваясь от снега, спросила мать, — из-за чего без меня была драка? — Драки не было, — отказался Чук. — Не было, — подтвердил Гек. — Мы только хотели подраться, да сразу раздумали. — Очень я люблю такое раздумье, — сказала мать. Она разделась, села на диван и показала им твердые зеленые билеты: один билет большой, а два маленьких. Вскоре они поужинали, а потом утих стук, погас свет, и все уснули. А про телеграмму мать ничего не знала, поэтому, конечно, ничего не спросила. Назавтра они уехали. Но так как поезд уходил очень поздно, то сквозь черные окна Чук и Гек при отъезде ничего интересного не увидели. Ночью Гек проснулся, чтобы напиться. Лампочка на потолке была потушена, однако все вокруг Гека было озарено голубым светом: и вздрагивающий стакан на покрытом салфеткой столике, и желтый апельсин, который казался теперь зеленоватым, и лицо мамы, которая, покачиваясь, спала крепко-крепко. Через снежное узорное окно вагона Гек увидел луну, да такую огромную, какой в Москве и не бывает. И тогда он решил, что поезд уже мчится по высоким горам, откуда до луны ближе. Он растолкал маму и попросил напиться. Но пить ему она по одной причине не дала, а велела отломить и съесть дольку апельсина. Гек обиделся, дольку отломил, но спать ему уже не захотелось. Он потолкал Чука — не проснется ли. Чук сердито фыркнул и не просыпался. Тогда Гек надел валенки, приоткрыл дверь и вышел в коридор. Коридор вагона был узкий и длинный. Возле наружной стены его были приделаны складные скамейки, которые сами с треском захлопывались, если с них слезешь. Сюда же, в коридор, выходило еще десять дверей. И все двери были блестящие, красные, с желтыми золочеными ручками. Гек посидел на одной скамейке, потом на другой, на третьей и так добрался почти до конца вагона. Но тут прошел проводник с фонарем и пристыдил Гека, что люди спят, а он скамейками хлопает. Проводник ушел, а Гек поспешно направился к себе в купе. Он с трудом приоткрыл дверь. Осторожно, чтобы не разбудить маму, закрыл и кинулся на мягкую постель. А так как толстый Чук развалился во всю ширь, то Гек бесцеремонно ткнул его кулаком, чтобы тот подвинулся. Но тут случилось нечто страшное: вместо белобрысого круглоголового Чука на Гека глянуло сердитое усатое лицо какого-то дядьки, который строго спросил: -— Это кто же здесь толкается? Тогда Гек завопил что было мочи. Перепуганные пассажиры повскакали со всех полок, вспыхнул свет, и, увидав, что он попал не в свое купе, а в чужое, Гек заорал еще громче. Но все люди быстро поняли, в чем дело, и стали смеяться. Усатый дядька надел брюки, военную гимнастерку и отвел Гека на место. Гек проскользнул под свое одеяло и притих. Вагон покачивало, шумел ветер. Невиданная огромная луна опять озаряла голубым светом вздрагивающий стакан, оранжевый апельсин на белой салфетке и лицо матери, которая во сне чему-то улыбалась и совсем не знала, какая беда приключилась с ее сыном. Наконец заснул и Гек. ...И снился Геку странный сон Как будто ожил весь вагон, Как будто слышны голоса От колеса до колеса Бегут вагоны — длинный ряд — И с паровозом говорят. Первый. Вперед, товарищ! Путь далек Перед тобой во мраке лег. Второй. Светите ярче, фонари, До самой утренней зари! Третий. Гори, огонь! Труби, гудок! Крутись, колеса, на Восток! Четвертый. Тогда закончим разговор, Когда домчим до Синих гор. Когда Гек проснулся, колеса, уже без всяких разговоров, мерно постукивали под полом вагона. Сквозь морозные окна светило солнце. Постели были заправлены. Умытый Чук грыз яблоко. А мама и усатый военный против распахнутых дверей хохотали над ночными похождениями Гека. Чук сразу же показал Геку карандаш с наконечником из желтого патрона, который он получил в подарок от военного. Но Гек до вещей был не завистлив и не жаден. Он, конечно, был растеря и разиня. Мало того, что он ночью забрался в чужое купе, — вот и сейчас он не мог вспомнить, куда засунул свои брюки. Но зато Гек умел петь песни. Умывшись и поздоровавшись с мамой, он прижался лбом к холодному стеклу и стал смотреть, что это за край, как здесь живут и что делают люди. И пока Чук ходил от дверей к дверям и знакомился с пассажирами, которые охотно дарили ему всякую ерунду — кто резиновую пробку, кто гвоздь, кто кусок крученой бечевки, — Гек за это время увидел через окно немало. Вот лесной домик. В огромных валенках, в одной рубашке и с кошкой в руках выскочил на крыльцо мальчишка. Трах! — кошка кувырком полетела в пушистый сугроб и, неловко карабкаясь, запрыгала по рыхлому снегу. Интересно, за что это он ее бросил? Вероятно, что-нибудь со стола стянула. Но уже нет ни домика, ни мальчишки, ни кошки — стоит в поле завод. Поле белое, трубы красные. Дым черный, а свет желтый. Интересно, что на этом заводе делают? Вот будка, и, укутанный в тулуп, стоит часовой. Часовой в тулупе огромный, широкий, и винтовка его кажется тоненькой, как соломинка. Однако попробуй-ка, сунься! ";
    dataset += "Потом пошел танцевать лес. Деревья, что были поближе, прыгали быстро, а дальние двигались медленно, как будто их тихо кружила славная снежная река. Гек окликнул Чука, который возвращался в купе с богатой добычей, и они стали смотреть вместе. Встречались на пути станции большие, светлые, на которых шипело и пыхтело сразу штук по сто паровозов; встречались станции и совсем крохотные — ну, право, не больше того продуктового ларька, что торговал разной мелочью на углу возле их московского дома. Проносились навстречу поезда, груженные рудой, углем и громадными, толщиной в полвагона, бревнами. Нагнали они эшелон с быками и коровами. Паровозишко у этого эшелона был невзрачный, и гудок у него тонкий, писклявый, а тут как один бык рявкнул: му-у!.. Даже машинист обернулся и, наверное, подумал, что это его большой паровоз нагоняет А на одном разъезде бок о бок остановились они рядом с могучим железным бронепоездом. Грозно торчали из башен укутанные брезентом орудия. Красноармейцы весело топали, смеялись и, хлопая варежками, отогревали руки. Но один человек в кожанке стоял возле бронепоезда, молчалив и задумчив. И Чук с Геком решили, что это, конечно, командир, который стоит и ожидает, не придет ли приказ от Ворошилова открыть против врагов бой. Да, немало всякого они за дорогу повидали. Жаль только, что на дворе бушевали метели и окна вагона часто бывали наглухо залеплены снегом. И вот наконец утром поезд подкатил к маленькой станции. Только-только мать успела осадить Чука с Геком и принять от военного вещи, как поезд умчался. Чемоданы были свалены на снег. Деревянная платформа вскоре опустела, а отец встречать так и не вышел. Тогда мать на отца рассердилась и, оставив детей караулить вещи, пошла к ямщикам узнавать, какие за ними отец прислал сани, потому что до того места, где он жил, оставалось ехать еще километров сто тайгою. Мать ходила очень долго, а тут еще неподалеку появился страшенный козел. Сначала он глодал кору с замороженного бревна, но потом противно мемекнул и что-то очень пристально стал на Чука с Геком поглядывать. Тогда Чук и Гек поспешно укрылись за чемоданами потому что кто его знает, что в этих краях козлам надо. Но вот вернулась мать. Она была совсем опечалена и объяснила, что, вероятно, отец телеграмму о их выезде не получил и поэтому лошадей на станцию он за ними не прислал. Тогда они позвали ямщика. Ямщик длинным кнутом огрел козла по спине, забрал вещи и понес их в буфет вокзала. Буфет был маленький. За стойкой пыхтел толстый, ростом с Чука, самовар. Он дрожал, гудел, и густой пар его, как облако, поднимался к бревенчатому потолку, под которым чирикали залетевшие погреться воробьи. Пока Чук с Геком пили чай, мать торговалась с ямщиком: сколько он возьмет, чтобы довезти их в лес до места. Ямщик просил очень много — целых сто рублей. Да и то сказать: дорога и на самом деле была не ближняя. Наконец они договорились, и ямщик побежал домой за хлебом, за сеном и за теплыми тулупами. — Отец и не знает, что мы уже приехали, — сказала мать. — То-то он удивится и обрадуется! russpass.ru Реклама RUSSPASS — Планировщик путешествий Музей. Кино. Ресторан. Звучит как план! Используйте готовые маршруты по Москве. Узнать больше — Да, он обрадуется, — прихлебывая чай, важно подтвердил Чук. — И я удивлюсь и обрадуюсь тоже. — И я тоже, — согласился Гек. — Мы подъедем тихонько, и если папа куда-нибудь вышел из дома, то мы чемоданы спрячем, а сами залезем под кровать. Вот он приходит. Сел. Задумался. А мы молчим, молчим, да вдруг как завоем! — Я под кровать не полезу, — отказалась мать, — и выть не буду тоже. Лезьте и войте сами... Зачем ты, Чук, сахар в карман прячешь? И так у тебя карманы полны, как мусорный ящик. — Я лошадей кормить буду, — спокойно объяснил Чук. — Забирай, Гек, и ты кусок ватрушки. А то у тебя никогда ничего нет. Только и знаешь у меня выпрашивать! Вскоре пришел ямщик. Уложили в широкие сани багаж, взбили сено, укутались одеялами, тулупами. Прощайте, большие города, заводы, станции, деревни, поселки! Теперь впереди только лес, горы и опять густой, темный лес. ...Почти до сумерек, охая, ахая и дивясь на дремучую тайгу, они проехали незаметно. Но вот Чуку, которому из- за спины ямщика плохо была видна дорога, стало скучно. Он попросил у матери пирожка или булки. Но ни пирожка, ни булки мать ему, конечно, не дала. Тогда он насупился и от нечего делать стал толкать Гека и отжимать его к краю. Сначала Гек терпеливо отпихивался. Потом вспылил и плюнул на Чука. Чук обозлился и кинулся в драку. Но так как руки их были стянуты тяжелыми меховыми тулупами, то они ничего не могли поделать, кроме как стукать друг друга укутанными в башлыки лбами. Посмотрела на них мать и рассмеялась. А тут ямщик ударил кнутом по коням — и рванули кони. Выскочили на дорогу и затанцевали два белых пушистых зайца. Ямщик закричал: — Эй, эй! Ого-го!.. Берегись: задавим! Весело умчались в лес озорные зайцы. Дул в лицо свежий ветер. И, поневоле прижавшись друг к другу, Чук и Гек помчались в санях под гору навстречу тайге и навстречу луне, которая медленно выползала из-за уже недалеких Синих гор. Но вот безо всякой команды кони стали возле маленькой, занесенной снегом избушки. — Здесь ночуем, — сказал ямщик, соскакивая в снег. —_ Это наша станция. Избушка была маленькая, но крепкая. Людей в ней не было. Быстро вскипятил ямщик чайник; принесли из саней сумку с продуктами. Колбаса до того замерзла и затвердела, что ею можно было забивать гвозди. Колбасу ошпарили кипятком, а куски хлеба положили на горячую плиту. За печкой Чук нашел какую-то кривую пружину, и ямщик сказал ему, что это пружина от капкана, которым ловят всякого зверя. Пружина была ржавая и валялась без дела. Это Чук сообразил сразу. Попили чаю, поели и легли спать. У стены стояла широкая деревянная кровать. Вместо матраца на ней были навалены сухие листья. Гек не любил спать ни у стены, ни посредине. Он любил спать с краю. И хотя еще с раннего детства он слыхал песню «Баю-баюшки-баю, не ложися на краю», Гек все равно всегда спал с краю. Если же его клали в середку, то во сне он сбрасывал со всех одеяла, отбивался локтями и толкал Чука в живот коленом. Не раздеваясь и укрывшись тулупами, они улеглись: Чук у стенки, мать посредине, а Гек с краю. Ямщик потушил свечку и полез на печь. Разом все уснули. Но, конечно, как и всегда, ночью Геку захотелось пить, и он проснулся. В полудреме он надел валенки, добрался до стола, глотнул воды из чайника и сел перед окном на табуретку. Луна была за тучками и, сквозь маленькое окошко сугробы снега казались черно-синими. «Вот как далеко занесло нашего папу!» — удивился Гек. И он подумал, что, наверное, дальше, чем это место, уже и не много осталось мест на свете. Но вот Гек прислушался. За окном ему почудился стук. Это был даже не стук, а скрип снега под чьими-то тяжелыми шагами. Так и есть! Вот во тьме что-то тяжело вздохнуло, зашевелилось, заворочалось, и Гек понял, что это мимо окна прошел медведь. — Злобный медведь, что тебе надо? Мы так долго едем к папе, а ты хочешь нас сожрать, чтобы мы его никогда не увидели?.. Нет, уходи прочь, пока люди не убили тебя метким ружьем или острой саблей! Так думал и бормотал Гек, а сам со страхом и любопытством крепче и крепче прижимался лбом к обледенелому стеклу узкого окошка. Но вот из-за быстрых туч стремительно выкатилась луна. Черно-синие сугробы засверкали мягким матовым блеском, и Гек увидел, что медведь этот вовсе не медведь, а просто это отвязавшаяся лошадь ходит вокруг саней и ест сено. Было досадно. Гек залез на кровать под тулуп, а так как только что он думал о нехорошем, то и сон к нему пришел угрюмый. Приснился Геку странный сон! Как будто страшный Турворон Плюет слюной, как кипятком, Грозит железным кулаком. Кругом пожар! В снегу следы! Идут солдатские ряды. И волокут из дальних мест Кривой фашистский флаг и крест. — Постойте! — закричал им Гек. — Вы не туда идете! Здесь нельзя! Но никто не постоял, и его, Гека, не слушали. В гневе тогда выхватил Гек жестяную сигнальную дуду, ту, что лежала у Чука в картонке из-под ботинок, и загудел так громко, что быстро поднял голову задумчивый командир железного бронепоезда, властно махнул рукой - и разом ударили залпом его тяжелые и грозные орудия. — Хорошо! — похвалил Гек. — Только стрельните еще а то одного раза им, наверное, мало... Мать проснулась оттого, что оба ее дорогих сына с двух сторон нестерпимо толкались и ворочались. Она повернулась к Чуку и почувствовала, как в бок ей ткнуло что-то твердое и острое. Она пошарила и достала из-под одеяла пружину от капкана, которую запасливый Чук тайно притащил с собой в постель. Мать швырнула пружину за кровать. При свете луны она заглянула в лицо Геку и поняла, что ему снится тревожный сон. Сон, конечно, не пружина, и его нельзя выкинуть. Но его можно потушить. Мать повернула Гека со спины на бок и, покачивая, тихонько подула на его теплый лоб. Вскоре Гек засопел, улыбнулся, и это означало, что плохой сон погас. Тогда мать встала и в чулках, без валенок, подошла к окошку. Еще не светало, и небо было все в звездах. Иные звезды горели высоко, а иные склонялись над черной тайгой совсем низко. И — удивительное дело! — тут же и так же, как маленький Гек, она подумала, что дальше, чем это место, куда занесло ее беспокойного мужа, наверное, и не много осталось мест на свете. Весь следующий день дорога шла лесом и горами. На подъемах ямщик соскакивал с саней и шел по снегу рядом. Но зато на крутых спусках сани мчались с такой быстротой, что Чуку с Геком казалось, будто бы они вместе с лошадьми и санями проваливаются на землю прямо с неба. Наконец под вечер, когда и люди и кони уже порядком устали, ямщик сказал: — Ну, вот и приехали! За этим мыском поворот. Тут, на поляне, и стоит ихняя база... Эй, но-о!.. Наваливай! Весело взвизгнув, Чук и Гек вскочили, но сани дернули, и они дружно плюхнулись в сено. Улыбающаяся мать скинула шерстяной платок и осталась только в пушистой шапке. Вот и поворот. Сани лихо развернулись и подкатили к трем домишкам, которые торчали на небольшой, укрытой от ветров опушке. ";
    dataset += "Очень странно! Не лаяли собаки, не было видно людей. Не валил дым из печных труб. Все дорожки были занесены глубоким снегом, а кругом стояла тишина, как зимой на кладбище. И только белобокие сороки бестолково скакали с дерева на дерево. — Ты куда же нас привез? — в страхе спросила у ямщика мать. — Разве нам сюда надо? — Куда рядились, туда и привез, — ответил ямщик. — Вот эти дома называются «Разведывательно-геологическая база номер три». Да вот и вывеска на столбе... Читайте. Может быть, вам нужна база под названием номер четыре? Так то километров двести совсем в иную сторону. — Нет, нет! — взглянув на вывеску, ответила мать. — Нам нужна эта самая. Но ты посмотри: двери на замках, крыльцо в снегу, а куда же девались люди? — Я не знаю, куда б им деваться, — удивился и сам ямщик. — На прошлой неделе мы сюда продукт возили: муку, лук, картошку. Все люди тут были: восемь человек, начальник девятый, со сторожем десять... Вот еще забота! Не волки же их всех поели... Да вы постойте, я пойду посмотрю в сторожку. И, сбросив тулуп, ямщик зашагал через сугробы к крайней избушке. Вскоре он вернулся: — Изба пуста, а печка теплая. Значит, здесь сторож, да, видать, ушел на охоту. Ну, к ночи вернется и все вам расскажет. — Да что он мне расскажет! — ахнула мать. — Я и сама вижу, что людей здесь уже давно нету -— Это я уж не знаю, что он расскажет, — ответил ямщик. — А что-нибудь рассказать должен, на то он и сторож. С трудом подъехали они к крыльцу сторожки, от которого к лесу вела узенькая тропка. Они вошли в сени и мимо лопат, метел, топоров, палок, мимо промерзлой медвежьей шкуры, что висела на железном крюку, прошли в избушку. Вслед за ними ямщик тащил вещи. В избушке было тепло. Ямщик пошел задавать лошадям корм, а мать молча раздевала перепуганных ребятишек. — Ехали к отцу, ехали — вот тебе и приехали! Мать села на лавку и задумалась. Что случилось, почему на базе пусто и что теперь делать? Ехать назад? Но у нее денег оставалось только-только заплатить ямщику за дорогу. Значит, надо было ожидать, когда вернется сторож. Но ямщик через три часа уедет обратно, а вдруг сторож возьмет да не скоро вернется? Тогда как? А ведь отсюда до ближайшей станции и телеграфа почти сто километров! Вошел ямщик. Оглядев избу, он потянул носом воздух, подошел к печке и открыл заслонку. — Сторож к ночи вернется, — успокоил он. — Вот в печи горшок со щами. Кабы он ушел надолго, он бы щи на холод вынес... А то как хотите, — предложил ямщик. — Раз уж такое дело, то я не чурбак. Я вас назад до станции бесплатно доставлю. — Нет, — отказалась мать. — На станции нам делать нечего. Опять поставили чайник, подогрели колбасу, поели, попили, и, пока мать разбирала вещи, Чук с Геком забрались на теплую печку. Здесь пахло березовыми вениками, горячей овчиной и сосновыми щепками. А так как расстроенная мать была молчалива, то Чук с Геком молчали тоже. Но долго молчать не намолчишься, и поэтому, не найдя себе никакого дела, Чук и Гек быстро и крепко уснули. Они не слышали, как уехал ямщик и как мать, забравшись на печку, улеглась с ними рядом. Они проснулись уже тогда, когда в избе было совсем темно. Проснулись все разом, потому что на крыльце послышался топот, потом что-то в сенях загрохотало — должно быть, упала лопата. Распахнулась дверь, и с фонарем в руках в избу вошел сторож, а с ним большая лохматая собака. Он скинул с плеча ружье, бросил на лавку убитого зайца и, поднимая фонарь к печке, спросил: — Это что же за гости сюда приехали? — Я жена начальника геологической партии Серегина, —- сказала мать, соскакивая с печки, — а это его дети. Если нужно, то вот документы. — Вон они, документы: сидят на печке, — буркнул сторож и посветил фонарем на встревоженные лица Чука и Гека. — Как есть в отца — копия! Особо вот этот толстый. — И он ткнул на Чука пальцем. Чук и Гек обиделись: Чук — потому, что его назвали толстым, а Гек — потому, что он всегда считал себя похожим на отца больше, чем Чук. — Вы зачем, скажите, приехали? — глянув на мать, спросил сторож. — Вам же приезжать было не велено. — Как не велено? Кем это приезжать не велено? — А так и не велено. Я сам на станцию возил от Серегина телеграмму, а в телеграмме ясно написано: «Задержись выезжать на две недели. Наша партия срочно выходит в тайгу». Раз Серегин пишет «задержись» — значит, и надо было держаться, а вы самовольничаете. — Какую телеграмму? — переспросила мать. — Мы никакой телеграммы не получали. — И, как бы ища поддержки, она растерянно глянула на Чука и Гека. Но под ее взглядом Чук и Гек, испуганно тараща друг на друга глаза, поспешно попятились глубже на печку. — Дети, — подозрительно глянув на сыновей, спросила мать, — вы без меня никакой телеграммы не получали? На печке захрустели сухие щепки, веники, но ответа на вопрос не последовало. — Отвечайте, мучители! — сказала тогда мать. — Вы, наверное, без меня получили телеграмму и мне ее не отдали? Прошло еще несколько секунд, потом с печки раздался ровный и дружный рев. Чук затянул басовито и однотонно, а Гек выводил потоньше и с переливами. — Вот где моя погибель! — воскликнула мать. — Вот кто, конечно, сведет меня в могилу! Да перестаньте вы гудеть и расскажите толком, как было дело. Однако, услыхав, что мать собирается идти в могилу, Чук с Геком взвыли еще громче, и прошло немало времени, пока, перебивая и бесстыдно сваливая вину друг на друга, они затянули свой печальный рассказ. Ну что с таким народом будешь делать? Поколотить их палкой? Посадить в тюрьму? Заковать в кандалы и отправить на каторгу? Нет, ничего этого мать не сделала. Она вздохнула, приказала сыновьям слезть с печки, вытереть носы и умыться, а сама стала спрашивать сторожа, как же ей теперь быть и что делать. Сторож сказал, что разведывательная партия по срочному приказу ушла к ущелью Алкараш и вернется никак не раньше чем дней через десять. — Но как же мы эти десять дней жить будем? — спросила мать. — Ведь у нас с собой нет никакого запаса. — А так вот и живите, — ответил сторож. — Хлеба я вам дам, вон подарю зайца — обдерете и сварите. А я завтра на двое суток в тайгу уйду, мне капканы проверять надо. — Нехорошо, — сказала мать. — Как же мы останемся одни? Мы тут ничего не знаем. А здесь лес, звери... — Я второе ружье оставлю, — сказал сторож. — Дрова под навесом, вода в роднике за пригорком. Вон крупа в мешке, соль в банке. А мне — я вам прямо скажу — нянчиться с вами тоже некогда... — Эдакий злой дядька! — прошептал Гек. — Давай, Чук, мы с тобой ему что-нибудь скажем. — Вот еще! — отказался Чук. — Он тогда возьмет и вовсе нас из дому выгонит. Ты погоди, приедет папа, мы ему все и расскажем. — Что ж папа! Папа еще долго... Гек подошел к матери, сел к ней на колени и, сдвинув брови, строго посмотрел в лицо грубому сторожу. Сторож снял меховой кожух и подвинулся к столу, к свету. И только тут Гек разглядел, что от плеча к спине кожуха вырван огромный, почти до пояса, меховой клок. — Достань из печки щи, — сказал матери сторож. — Вон на полке ложки, миски, садитесь и ешьте. А я шубу чинить буду. — Ты хозяин, — сказала мать. — Ты достань, ты и угощай. А полушубок дай: я лучше твоего заплатаю. Сторож поднял на нее глаза и встретил суровый взгляд Гека. — Эге! Да вы, я вижу, упрямые, — пробурчал он, протянул матери полушубок и полез за посудой на полку. 16 - Хрестоматия — Это где так разорвалось? — спросил Чук, указывая на дыру кожуха. — С медведем не поладили. Вот он меня и царапнул —- нехотя ответил сторож и бухнул на стол тяжелый горшок со щами. — Слышишь, Гек? — сказал Чук, когда сторож вышел в сени. — Он подрался с медведем и, наверное, от этого сегодня такой сердитый. Гек слышал все сам. Но он не любил, чтобы кто-либо обижал его мать, хотя бы это и был человек, который мог поссориться и подраться с самим медведем. Утром, еще на заре, сторож захватил с собой мешок, ружье, собаку, стал на лыжи и ушел в лес. Теперь хозяйничать надо было самим. Втроем ходили они за водой. За пригорком из отвесной скалы среди снега бил ключ. От воды, как из чайника, шел густой пар, но когда Чук подставил под струю палец, то оказалось, что вода холодней самого мороза. Потом они таскали дрова. Русскую печь мать топить не умела, и поэтому дрова долго не разгорались. Но зато когда разгорелись, то пламя запылало так жарко, что толстый лед на окне у противоположной стенки быстро растаял. И теперь через стекло видна была и вся опушка с деревьями, по которым скакали сороки, и скалистые вершины Синих гор. Кур мать потрошить умела, но обдирать зайца ей еще не приходилось, и она с ним провозилась столько, что за это время можно было ободрать и разделать быка или корову. Геку это обдирание ничуть не понравилось, но Чук помогал охотно, и за это ему достался зайчиный хвост, такой легкий и пушистый, что если его бросать с печки, то он падал на пол плавно, как парашют. После обеда они все втроем вышли гулять. Чук уговаривал мать, чтобы она взяла с собой ружье или хотя бы ружейные патроны. Но мать ружья не взяла. Наоборот, она нарочно повесила ружье на высокий крюк, потом встала на табуретку, засунула патроны на верхнюю полку и предупредила Чука, что если он попробует стянуть хоть один патрон с полки, то на хорошую жизнь пусть больше и не надеется. Чук покраснел и поспешно удалился, потому что один патрон уже лежал у него в кармане. Удивительная это была прогулка! Они шли гуськом к роднику по узенькой тропке. Над ними сияло холодное голубое небо; как сказочные замки и башни, поднимались к небу остроконечные утесы Синих гор. В морозной тишине резко стрекотали любопытные сороки. Меж густых кедровых ветвей бойко прыгали серые юркие белки. Под деревьями, на мягком белом снегу отпечатались причудливые следы незнакомых зверей и птиц. Вот в тайге что-то застонало, загудело, треснуло. Должно быть, ломая сучья, обвалилась с вершины дерева гора обледенелого снега. ";
    dataset += "Раньше, когда Гек жил в Москве, ему представлялось, что вся земля состоит из Москвы, то есть из улиц, домов, трамваев и автобусов. Теперь же ему казалось, что вся земля состоит из высокого дремучего леса. Да и вообще, если над Геком светило солнце, то он был уверен, что и над всей землей ни дождя, ни туч нету. И если ему было весело, то он думал, что и всем на свете людям хорошо и весело тоже. Прошло два дня, наступил третий, а сторож из леса не возвращался, и тревога нависла над маленьким, занесенным снегом домиком. Особенно страшно было по вечерам и ночами. Они крепко запирали сени, двери и, чтобы не привлечь зверей светом, наглухо занавешивали половиком окна, хотя надо было делать совсем наоборот, потому что зверь — не человек и он огня боится. Над печной трубой, как и полагается, гудел ветер, а когда вьюга хлестала острыми снежными льдинками по стене и окнам, то всем казалось, что снаружи кто-то толкается и царапается. Они забрались спать на печку, и там мать долго рассказывала им разные истории и сказки. Наконец она задремала. — Чук, — спросил Гек, — почему волшебники бывают в разных историях и сказках? А что, если бы они были и на самом деле? — И ведьмы и черти чтобы были тоже? — спросил Чук. — Да нет! — с досадой отмахнулся Гек. — Чертей не надо. Что с них толку? А мы бы попросили волшебника, он слетал бы к папе и сказал бы ему, что мы уже давно приехали. — А на чем бы он полетел, Гек? — Ну, на чем... Замахал бы руками или там еще как. Он уж сам знает. — Сейчас руками махать холодно, — сказал Чук. — У меня вон какие перчатки да варежки, да и то, когда я тащил полено, у меня пальцы совсем замерзли. — Нет, ты скажи, Чук, а все-таки хорошо бы? — Я не знаю, — заколебался Чук. — Помнишь, во дворе, в подвале, где живет Мишка Крюков, жил какой-то хромой. То он торговал баранками, то к нему приходили всякие бабы, старухи, и он им гадал, кому будет жизнь счастливая и кому несчастная. — И хорошо он нагадывал? — Я не знаю. Я знаю только, что потом пришла милиция, его забрали, а из его квартиры много чужого добра вытащили. — Так он, наверное, был не волшебник, а жулик. Ты как думаешь? — Конечно, жулик, — согласился Чук. — Да, я так думаю, и все волшебники должны быть жуликами. Ну, скажи, зачем ему работать, раз он и так во всякую дыру пролезть может? Знай только хватай, что надо... Ты бы лучше спал, Гек, все равно я с тобой больше разговаривать не буду. — Почему? — Потому что ты городишь всякую ерунду, а ночью она тебе приснится, ты и начнешь локтями да коленями дрыгать. Думаешь, хорошо, как ты мне вчера кулаком в живот бухнул? Дай-ка я тебе бухну тоже... На утро четвертого дня матери самой пришлось колоть дрова. Заяц был давно съеден, и кости его расхватаны сороками. На обед они варили только кашу с постным маслом и луком. Хлеб был на исходе, но мать нашла муку и испекла лепешек. После такого обеда Гек был грустен, и матери показалось, что у него повышена температура. Она приказала ему сидеть дома, одела Чука, взяла ведра, салазки, и они вышли, чтобы привезти воды и заодно набрать на опушке сучьев и веток, — тогда утром легче будет растапливать печку. Гек остался один. Он ждал долго. Ему стало скучно, и он начал что-то придумывать. ...А мать и Чук задержались. На обратном пути к дому санки перевернулись, ведра опрокинулись, и пришлось ехать к роднику снова. Потом выяснилось, что Чук на опушке позабыл теплую варежку, и с полпути пришлось возвращаться. Пока искали, пока то да се, наступили сумерки. Когда они вернулись домой, Гека в избе не было. Сначала они подумали, что Гек спрятался на печке за овчинами. Нет, там его не было. Тогда Чук хитро улыбнулся и шепнул матери, что Гек, конечно, залез под печку. Мать рассердилась и приказала Геку вылезать. Гек не откликался. Тогда Чук взял длинный ухват и стал им под печкой ворочать. Но и под печкой Гека не было. Мать встревожилась, взглянула на гвоздь у двери. Ни полушубок Гека, ни шапка на гвозде не висели. Мать вышла во двор, обошла кругом избушку. Зашла в сени, зажгла фонарь. Заглянула в темный чулан, под навес с дровами... Она звала Гека, ругала, упрашивала, но никто не отзывался. А темнота быстро ложилась на сугробы. Тогда мать заскочила в избу, сдернула со стены ружье, достала патроны, схватила фонарь и, крикнув Чуку, чтобы он не смел двигаться с места, выбежала во двор. Следов за четыре дня было натоптано немало. Где искать Гека, мать не знала, но она побежала к дороге, так как не верила, чтобы Гек один мог осмелиться зайти в лес. На дороге было пусто. Она зарядила ружье и выстрелила. Прислушалась, выстрелила еще и еще раз. Вдруг совсем неподалеку ударил ответный выстрел. Кто-то спешил к ней на помощь. Она хотела бежать навстречу, но ее валенки увязли в сугробе. Фонарь попал в снег, стекло лопнуло, и свет погас. С крыльца сторожки раздался пронзительный крик Чука. Это, услыхав выстрелы, Чук решил, что волки, которые сожрали Гека, напали на его мать. Мать отбросила фонарь и, задыхаясь, побежала к дому. Она втолкнула раздетого Чука в избу, швырнула ружье в угол и, зачерпнув ковшом, глотнула ледяной воды. У крыльца раздался гром и стук. Распахнулась дверь. В Избу влетела собака, а за нею вошел окутанный паром сторож. — Что за беда? Что за стрельба? — спросил он, не здороваясь и не раздеваясь. — Пропал мальчик, — сказала мать. Слезы ливнем хлынули из ее глаз, и она больше не могла сказать ни слова. — Стой, не плачь! — гаркнул сторож. — Когда пропал? Давно? Недавно?.. Назад, Смелый! — крикнул он собаке. -— Да говорите же, или я уйду обратно! — Час тому назад, — ответила мать. — Мы ходили за водой. Мы пришли, а его нет. Он оделся и куда-то ушел. — Ну, за час он далеко не уйдет, а в одеже и в валенках сразу не замерзнет... Ко мне, Смелый! На, нюхай! Сторож сдернул с гвоздя башлык и подвинул под нос собаки калоши Гека. Собака внимательно обнюхала вещи и умными глазами посмотрела на хозяина. — За мной! — распахивая дверь, сказал сторож. — Иди ищи, Смелый! Собака вильнула хвостом и осталась стоять на месте. — Вперед! — строго повторил сторож. — Ищи, Смелый, ищи! Собака беспокойно крутила носом, переступала с ноги на ногу и не двигалась. — Это еще что за танцы? — рассердился сторож. И, опять сунув собаке под нос башлык и калоши Гека, он дернул ее за ошейник. Однако Смелый за сторожем не пошел; он покрутился, повернулся и пошел в противоположный от двери угол избы. Здесь он остановился около большого деревянного сундука, царапнул по крышке мохнатой лапой и, обернувшись к хозяину, три раза громко и лениво гавкнул. Тогда сторож сунул ружье в руки оторопелой матери, подошел и открыл крышку сундука. В сундуке, на куче всякого тряпья, овчин, мешков, укрывшись своей шубенкой и подложив под голову шапку, крепко и спокойно спал Гек. Когда его вытащили и разбудили, то, хлопая сонными глазами, он никак не мог понять, отчего это вокруг него такой шум и такое буйное веселье. Мать целовала его и плакала. Чук дергал его за руки, за ноги, подпрыгивал и кричал: — Эй-ля! Эй-ли-ля!.. Лохматый пес Смелый, которого Чук поцеловал в морду, сконфуженно обернулся и, тоже ничего не понимая, тихонько вилял серым хвостом, умильно поглядывая на лежавшую на столе краюху хлеба. Оказывается, когда мать и Чук ходили за водой, то соскучившийся Гек решил пошутить. Он забрал полушубок, шапку и залез в сундук. Он решил, что когда они вернутся и станут его искать, то он из сундука страшно завоет. Но так как мать и Чук ходили очень долго, то он лежал, лежал и незаметно заснул. Вдруг сторож встал, подошел и брякнул на стол тяжелый ключ и измятый голубой конверт. — Вот, — сказал он, — получайте. Это вам ключ от комнаты и от кладовой и письмо от начальника Серегина. Он с людьми здесь будет через четверо суток, как раз к Новому году. Так вот он где пропадал, этот неприветливый, хмурый старик! Сказал, что идет на охоту, а сам бегал на лыжах к далекому ущелью Алкараш. Не распечатывая письма, мать встала и с благодарностью положила старику на плечо руку. Он ничего не ответил и стал ворчать на Гека за то, что тот рассыпал в сундуке коробку с пыжами, а заодно и на мать — за то, что она разбила стекло у фонаря. Он ворчал долго и упорно, но никто теперь этого доброго чудака не боялся. Весь этот вечер мать не отходила от Гека и, чуть что, хватала его за руку, как будто боялась, что вот-вот он опять куда-нибудь исчезнет. И так много она о нем заботилась, что наконец Чук обиделся и про себя уже несколько раз пожалел, что и он не полез в сундук тоже. Теперь стало весело. На следующее утро сторож открыл комнату, где жил их отец. Он жарко натопил печь и перенес сюда все их вещи. Комната была большая, светлая, но все в ней было расставлено и навалено без толку. Мать сразу же взялась за уборку Целый день она все переставляла, скоблила, мыла, чистила. И когда к вечеру сторож принес вязанку дров, то, удивленный переменой и невиданной чистотой, он остановился и не пошел дальше порога. А собака Смелый пошла. Она пошла прямо по свежевымытому полу, подошла к Геку и ткнула его холодным носом. Вот, мол, дурак, это я тебя нашла, и за это ты должен дать мне что-нибудь покушать. Мать раздобрилась и кинула Смелому кусок колбасы. Тогда сторож заворчал и сказал, что если в тайге собак кормить колбасой, так это сорокам на смех. Мать отрезала и ему полкруга. Он сказал «спасибо» и ушел, все чему-то удивляясь и покачивая головой. На следующий день было решено готовить к Новому году елку. Из чего-чего только не выдумывали они мастерить игрушки! Они ободрали все цветные картинки из старых журналов. Из лоскутьев и ваты понашили зверьков, кукол. Вытянули у отца из ящика всю папиросную бумагу и навертели пышных цветов. Уж на что хмур и нелюдим был сторож, а и тот, когда приносил дрова, подолгу останавливался у двери и дивился на их все новые и новые затеи. Наконец он не вытерпел. Он принес им серебряную бумагу от завертки чая и большой кусок воска, который у него остался от сапожного дела. Это было замечательно! И игрушечная фабрика сразу превратилась в свечной завод. Свечи были неуклюжие, неровные. Но горели они так же ярко, как и самые нарядные покупные. Теперь дело было за елкой. Мать попросила у сторожа топор, но он ничего на это ей даже не ответил, а стал на лыжи и ушел в лес. Через полчаса он вернулся. Ладно. Пусть игрушки были и не ахти какие нарядные, пусть зайцы, сшитые из тряпок, были похожи на кошек, пусть все куклы были на одно лицо — прямоносые и лупоглазые, и пусть, наконец, еловые шишки, обернутые серебряной бумагой, не так сверкали, как хрупкие и тонкие стеклянные игрушки, но зато такой елки в Москве, конечно, ни у кого не было. Это была настоящая таежная красавица — высокая, густая, прямая и с ветвями, которые расходились на концах, как звездочки. Четыре дня за делом пролетели незаметно. И вот наступил канун Нового года. Уже с утра Чука и Гека нельзя было загнать домой. С посинелыми носами они торчали на морозе, ожидая, что вот-вот из леса выйдет отец и все его люди. Но сторож, который топил баню, сказал им, чтобы они не мерзли онапрасну, потому что вся партия вернется только к обеду. И в самом деле. Только что они сели за стол, как сторож постучал в окошко. Кое-как одевшись, все втроем они вышли на крыльцо. — Теперь смотрите, — сказал им сторож. ";
    dataset += "— Вот они сейчас покажутся на скате той горы, что правей большой вершины, потом опять пропадут в тайге, и тогда через полчаса все будут дома. Так оно и вышло. Сначала из-за перевала вылетела собачья упряжка с гружеными санями, а за нею следом пронеслись быстроходные лыжники. По сравнению с громадой гор они казались до смешного маленькими, хотя отсюда были отчетливо видны их руки, ноги и головы. Они промелькнули по голому скату и исчезли в лесу. Ровно через полчаса послышался лай собак, шум, скрип, крики. Почуявшие дом голодные собаки лихо вынеслись из леса. А за ними, не отставая, выкатили на опушку девять лыжников. И, увидав на крыльце мать, Чука и Гека, они на бегу подняли лыжные палки и громко закричали: «Ура!» Тогда Гек не вытерпел, спрыгнул в крыльца и, зачерпывая снег валенками, помчался навстречу высокому, заросшему бородой человеку, который бежал впереди и кричал «ура» громче всех. Днем чистились, брились и мылись. А вечером была для всех елка, и все дружно встречали Новый год. Когда был накрыт стол, потушили лампу и зажгли свечи. Но так как, кроме Чука с Геком, остальные все были взрослые, то они, конечно, не знали, что теперь нужно делать. Хорошо, что у одного человека был баян и он заиграл веселый танец. Тогда все повскакали, и всем захотелось танцевать. И все танцевали очень прекрасно, особенно когда приглашали на танец маму. А отец танцевать не умел. Он был очень сильный, добродушный, и когда он без всяких танцев просто шагал по полу, то и то в шкафу звенела вся посуда. Он посадил себе Чука с Геком на колени, и они громко хлопали всем в ладоши. Потом танец окончился, и люди попросили, чтобы Гек спел песню. Гек не стал ломаться. Он и сам знал, что умеет петь песни, и гордился этим. Баянист подыгрывал, а он им спел песню. Какую — я уже сейчас не помню. Помню, что это была очень хорошая песня, потому что все люди, слушая ее, замолкли и притихли. И когда Гек останавливался, чтобы перевести дух, то было слышно, как потрескивали свечи и гудел за окном ветер. А когда Гек окончил петь, то все зашумели, закричали, подхватили Гека на руки и стали его подкидывать. Но мать тотчас же отняла у них Гека, потому что она испугалась, как бы сгоряча его не стукнули о деревянный потолок. — Теперь садитесь, — взглянув на часы, сказал отец. — Сейчас начнется самое главное. Он пошел и включил радиоприемник. Все сели и замолчали. Сначала было тихо. Но вот раздался шум, гул, гудки. Потом что-то стукнуло, зашипело, и откуда-то издалека донесся мелодичный звон. Большие и маленькие колокола звонили так: Тир-лиль-лил и-дон! Тир-лиль-лили-дон! Чук с Геком переглянулись. Они гадали, что это. Это в далекой-далекой Москве, под красной звездой, на Спасской башне звонили золотые кремлевские часы. И этот звон — перед Новым годом — сейчас слушали люди и в городах, и в горах, в степях, в тайге, на синем море. И, конечно, задумчивый командир бронепоезда, тот, что неутомимо ждал приказа от Ворошилова, чтобы открыть против врагов бой, слышал этот звон тоже. И тогда все люди встали, поздравили друг друга с Новым годом и пожелали всем счастья. Что такое счастье — это каждый понимал по-своему. Но все вместе люди знали и понимали, что надо честно жить, много трудиться и крепко любить и беречь эту огромную счастливую землю, которая зовется Советской страной.";
    return dataset;
}

int main() {
    setlocale(LC_ALL, "rus");
    std::string dataset = loadDataset();
    auto vocab = createStringVocabulary(dataset);
    float saved_loss = 11111.1;
    RNN rnn(vocab.size(), 324, vocab.size(), 0.003);

    std::vector<float> input(vocab.size(), 0.0f);
    std::vector<float> target(vocab.size(), 0.0f);

    for (int epoch = 0; epoch < 1000; ++epoch) {
        float total_loss = 0.0f;
        int num_threads = std::thread::hardware_concurrency() / 3 + std::thread::hardware_concurrency() % 3;
        size_t chunk_size = dataset.size() / num_threads;
        std::vector<std::thread> threads;

        for (int t = 0; t < num_threads; ++t) {
            size_t start_idx = t * chunk_size;
            size_t end_idx = (t == num_threads - 1) ? dataset.size() - 4 : start_idx + chunk_size;

            threads.emplace_back(trainBatch, std::ref(rnn), std::ref(dataset), std::ref(vocab), start_idx, end_idx, std::ref(total_loss));
        }
        if (saved_loss > total_loss) {
            rnn.saveWeights("newweights.txt");
        }
        for (auto& thread : threads) {
            thread.join();
        }

        std::cout << "Epoch " << epoch + 1 << " - Loss: " << total_loss << std::endl;

        std::string start_token = dataset.substr(0, 4);
        std::string generated_text = generateText(rnn, vocab, start_token, 100);

        std::cout << "Generated Text: " << generated_text << std::endl;
    }

    return 0;
}
    